# Настройка автоматической проверки депозитов (постбэки 1win)

Бот проверяет депозиты по постбэкам 1win: постбэки приходят в группу обсуждения канала, бот читает их и сопоставляет с ID 1win (sub1), который пользователь отправляет после нажатия «Готово».

## Текущая настройка (Towercheat_bot)

- **Группа обсуждения:** ID `-1003810391629`
- **Форматы постбэков 1win:**
  - Регистрация: `{sub1}`
  - Первый депозит: `{sub1}|{country}|Firstdep|{amount}`
  - Повторный депозит: `{sub1}|{country}|{amount}`

Где **sub1** — ID пользователя на 1win (его вводит пользователь в боте), **amount** — сумма в долларах (сохраняется в БД).

## Что нужно

1. **Канал** с включённой группой обсуждения (комментарии к постам).
2. **Постбэки 1win** должны отправляться в эту группу обсуждения (настраивается в партнёрке/интеграции 1win — укажите бота или сервис, который постит постбэки в группу).
3. **Бот** добавлен в группу обсуждения канала и может читать сообщения (права на чтение).

## Шаги

### 1. Узнать ID группы обсуждения

- Добавьте в группу обсуждения бота [@userinfobot](https://t.me/userinfobot) и перешлите туда любое сообщение из группы — он покажет `Chat ID` (число вида `-1001234567890`).
- Либо в логах бота при получении сообщения из группы будет `update.message.chat.id`.

### 2. Переменные окружения

В Railway / Render / .env задайте:

| Переменная | По умолчанию | Описание |
|------------|--------------|----------|
| `CHANNEL_DISCUSSION_GROUP_ID` | `-1003810391629` | ID группы обсуждения |
| `POSTBACK_USER_ID_REGEX` | `^([^\|]+)` | Регулярка: первый сегмент до `|` = sub1 |

### 3. Формат постбэков в группе

Бот извлекает **sub1** (ID пользователя 1win) как первый сегмент до `|`, и **amount** (сумма в $) как последний сегмент после `|`:

- `12345` → sub1=12345, amount не сохраняется
- `12345|RU|Firstdep|100` → sub1=12345, amount=100
- `12345|RU|500` → sub1=12345, amount=500

### 4. Поведение для пользователя

1. Пользователь нажимает «Пополнить», переходит по реф. ссылке 1win и вносит депозит.
2. В боте нажимает «Готово».
3. Бот просит прислать **ID на сайте 1win** (число или логин).
4. Пользователь пишет в чат боту свой ID 1win.
5. Бот ищет **необработанный** постбэк с таким же ID; если находит — выдаёт доступ и помечает постбэк обработанным.

Таймаут ожидания ввода ID — **15 минут** после нажатия «Готово». Если не успел — нужно снова нажать «Готово» и отправить ID.

## Если постбэки не в группе обсуждения

Если 1win шлёт постбэки на HTTP-URL (webhook), а не в Telegram, нужен отдельный сервис, который принимает эти запросы и постит текст в группу обсуждения канала (или бот должен принимать webhook — это уже другая схема). Текущая версия бота рассчитана на то, что постбэки уже приходят в группу обсуждения в виде сообщений.
